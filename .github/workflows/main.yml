name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Dorg.gradle.parallel=false
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "9477386"

jobs:
  # ====================================
  # Code Quality & Security Checks
  # ====================================
  quality-checks:
    name: ðŸ” Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-home-cache-cleanup: true

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ”§ Configure Android SDK
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"

      - name: ðŸ§¹ Kotlin Lint Check
        run: ./gradlew ktlintCheck --continue
        continue-on-error: true

      - name: ðŸ” Static Code Analysis (Detekt)
        run: ./gradlew detekt --continue
        continue-on-error: true

      - name: ðŸ› Android Lint
        run: ./gradlew lintDebug --continue
        continue-on-error: true

      - name: ðŸ”’ Dependency Vulnerability Scan
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'clipboard-history-android'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
        continue-on-error: true

      - name: ðŸ“Š Upload Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports-${{ github.run_number }}
          path: |
            app/build/reports/
            reports/
          retention-days: 30

  # ====================================
  # Unit & Integration Tests
  # ====================================
  test:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: quality-checks
    
    strategy:
      matrix:
        api-level: [24, 29, 34]
      fail-fast: false

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ”§ Configure Android SDK
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"

      - name: ðŸƒâ€â™‚ï¸ Run Unit Tests
        run: ./gradlew testDebugUnitTest --continue

      - name: ðŸ“Š Generate Test Coverage Report
        run: ./gradlew testDebugUnitTestCoverage --continue

      - name: ðŸ¤– Run Instrumented Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          script: ./gradlew connectedDebugAndroidTest --continue
        continue-on-error: true

      - name: ðŸ“Š Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-api${{ matrix.api-level }}-${{ github.run_number }}
          path: |
            app/build/reports/tests/
            app/build/reports/coverage/
            app/build/test-results/
          retention-days: 30

  # ====================================
  # Build APKs
  # ====================================
  build:
    name: ðŸ—ï¸ Build APKs
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality-checks, test]
    
    outputs:
      version-name: ${{ steps.version.outputs.version-name }}
      version-code: ${{ steps.version.outputs.version-code }}
      apk-debug: ${{ steps.build-debug.outputs.apk-path }}
      apk-release: ${{ steps.build-release.outputs.apk-path }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for version calculation

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ”§ Configure Android SDK
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"

      - name: ðŸ”¢ Calculate Version
        id: version
        run: |
          # Calculate version based on git commits and tags
          VERSION_CODE=$(git rev-list --count HEAD)
          if [[ "${{ github.ref }}" =~ refs/tags/v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION_NAME="${BASH_REMATCH[1]}"
          else
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION_BASE=${LAST_TAG#v}
            COMMIT_COUNT=$(git rev-list --count ${LAST_TAG}..HEAD 2>/dev/null || echo $VERSION_CODE)
            COMMIT_HASH=$(git rev-parse --short HEAD)
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              VERSION_NAME="${VERSION_BASE}-${COMMIT_COUNT}-${COMMIT_HASH}"
            else
              BRANCH_NAME=$(echo ${{ github.ref_name }} | sed 's/[^a-zA-Z0-9]/-/g')
              VERSION_NAME="${VERSION_BASE}-${BRANCH_NAME}-${COMMIT_COUNT}-${COMMIT_HASH}"
            fi
          fi
          
          echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ðŸ“± Version: $VERSION_NAME ($VERSION_CODE)"

      - name: ðŸ”§ Update Version in Build Files
        run: |
          sed -i "s/versionCode [0-9]*/versionCode ${{ steps.version.outputs.version-code }}/" app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"${{ steps.version.outputs.version-name }}\"/" app/build.gradle

      - name: ðŸ—ï¸ Build Debug APK
        id: build-debug
        run: |
          ./gradlew assembleDebug --no-daemon
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Debug APK built: $APK_PATH"

      - name: ðŸ—ï¸ Build Release APK
        id: build-release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
            export KEYSTORE_PATH=keystore.jks
            ./gradlew assembleRelease --no-daemon
            APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
            echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "ðŸŽ‰ Release APK built: $APK_PATH"
          else
            echo "âš ï¸ No keystore configured, skipping release build"
          fi

      - name: ðŸ“¦ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ steps.version.outputs.version-name }}
          path: ${{ steps.build-debug.outputs.apk-path }}
          retention-days: 90

      - name: ðŸ“¦ Upload Release APK
        if: steps.build-release.outputs.apk-path
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-${{ steps.version.outputs.version-name }}
          path: ${{ steps.build-release.outputs.apk-path }}
          retention-days: 365

  # ====================================
  # Deploy & Release
  # ====================================
  deploy:
    name: ðŸš€ Deploy & Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
      - name: ðŸ“¥ Download APK Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-apk-${{ needs.build.outputs.version-name }}"
          path: ./artifacts
          merge-multiple: true

      - name: ðŸ·ï¸ Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build.outputs.version-name }}
          name: ðŸŽ‰ Release v${{ needs.build.outputs.version-name }}
          body: |
            ## ðŸ“± Clipboard History v${{ needs.build.outputs.version-name }}
            
            ### ðŸŽ¯ Changes in this release
            - Automated build from commit ${{ github.sha }}
            - Version code: ${{ needs.build.outputs.version-code }}
            
            ### ðŸ“¥ Downloads
            - **Debug APK**: For testing and development
            - **Release APK**: Optimized for production use
            
            ### ðŸ”§ Installation
            1. Download the APK file
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK file
            4. Grant necessary permissions for clipboard access
            
            ### ðŸ›¡ï¸ Security
            All APKs are built using automated CI/CD pipeline with security scanning.
            Release APKs are signed with our official signing key.
          files: ./artifacts/*.apk
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ====================================
  # Notification & Cleanup
  # ====================================
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.build.outputs.version-name || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code**: ${{ needs.build.outputs.version-code || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Status**: ${{ needs.deploy.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY